<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{{ PRODUCT_NAME }}}</title>
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes" />
  <link rel="shortcut icon" href="TemplateData/favicon.ico" />

  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000;
    }
    #unity-container {
      position: fixed; inset: 0; width: 100%; height: 100%; background: #000;
    }
    #unity-canvas { width: 100%; height: 100%; display: block; background: #000; }
    #unity-loading-bar { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 300px; }
    #unity-progress-bar-empty { width: 100%; height: 18px; background: #555; border-radius: 9px; overflow: hidden; }
    #unity-progress-bar-full { width: 0%; height: 100%; background: #4caf50; }
    #unity-warning { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; }
    #unity-fullscreen-button {
      position: absolute; right: 12px; bottom: 12px; width: 36px; height: 36px;
      background: rgba(0,0,0,0.6); color: #fff; font-size: 14px;
      border-radius: 4px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; user-select: none;
    }
  </style>
</head>

<body>
  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
    <div id="unity-loading-bar">
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <div id="unity-warning"></div>
    <div id="unity-fullscreen-button">â›¶</div>
  </div>

  <script>
    const canvas = document.getElementById("unity-canvas");

    function unityShowBanner(msg, type) {
      const warningBanner = document.getElementById("unity-warning");
      const div = document.createElement("div");
      div.innerHTML = msg;
      div.style.padding = "10px";
      div.style.marginBottom = "5px";
      div.style.background = type === "error" ? "red" : "yellow";
      warningBanner.appendChild(div);
      if(type !== "error") setTimeout(() => warningBanner.removeChild(div), 5000);
    }

    function resizeCanvas() {
      canvas.style.width = "100%";
      canvas.style.height = "100%";
    }
    window.addEventListener("resize", resizeCanvas);
    window.addEventListener("orientationchange", resizeCanvas);
    resizeCanvas();

    const buildUrl = "Build";
    const loaderUrl = buildUrl + "/{{{ LOADER_FILENAME }}}";

    const config = {
      dataUrl: buildUrl + "/{{{ DATA_FILENAME }}}",
      frameworkUrl: buildUrl + "/{{{ FRAMEWORK_FILENAME }}}",
#if USE_WASM
      codeUrl: buildUrl + "/{{{ CODE_FILENAME }}}",
#endif
#if USE_THREADS
      workerUrl: buildUrl + "/{{{ WORKER_FILENAME }}}",
#endif
      streamingAssetsUrl: "StreamingAssets",
      companyName: {{{ JSON.stringify(COMPANY_NAME) }}},
      productName: {{{ JSON.stringify(PRODUCT_NAME) }}},
      productVersion: {{{ JSON.stringify(PRODUCT_VERSION) }}},
      showBanner: unityShowBanner,
      matchWebGLToCanvasSize: true,
    };

    document.getElementById("unity-loading-bar").style.display = "block";

    const script = document.createElement("script");
    script.src = loaderUrl;

    script.onload = async () => {
      try {
        // Fetch .wasm first to ensure GitHub Pages serves it correctly
#if USE_WASM
        const wasmResponse = await fetch(config.codeUrl);
        if(!wasmResponse.ok) throw new Error(".wasm fetch failed: " + wasmResponse.status);
        const wasmArrayBuffer = await wasmResponse.arrayBuffer();
        config.codeResponse = wasmArrayBuffer;
#endif

        createUnityInstance(canvas, config, (progress) => {
          document.getElementById("unity-progress-bar-full").style.width = (progress*100) + "%";
        }).then((unityInstance) => {
          document.getElementById("unity-loading-bar").style.display = "none";
          document.getElementById("unity-fullscreen-button").onclick = () => unityInstance.SetFullscreen(1);
        }).catch((err) => alert(err));
      } catch (err) {
        unityShowBanner("Failed to load WebAssembly: " + err, "error");
      }
    };

    document.body.appendChild(script);
  </script>
</body>
</html>
